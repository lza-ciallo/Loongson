# Simple Makefile for converting .s assembly files to .txt binary machine code
# Author: Created for LoongArch assembly to binary conversion
# Usage: make -f Makefile [target]

# Configuration
# Option 1: Auto-discover all .s files (default behavior)
ASM_FILES = $(wildcard *.s)

# Option 2: Manual file list (uncomment and modify as needed)
# TARGET_FILES = inst_la_alu.s inst_la_mem.s inst_la_branch.s
# ASM_FILES = $(TARGET_FILES)

TXT_FILES = $(ASM_FILES:.s=.txt)
OBJ_FILES = $(ASM_FILES:.s=.o)
ELF_FILES = $(ASM_FILES:.s=.elf)
BIN_FILES = $(ASM_FILES:.s=.bin)
DISASM_FILES = $(ELF_FILES:.elf=_disasm.s)

# LoongArch toolchain
AS = loongarch32r-linux-gnusf-as
LD = loongarch32r-linux-gnusf-ld
OBJCOPY = loongarch32r-linux-gnusf-objcopy

# Assembly flags
ASFLAGS = -mabi=ilp32

# Default target
default: all

# Generate all .txt files from .s files
all: $(TXT_FILES)
	@echo "=== All assembly files converted to binary machine code ==="
	@echo "Generated files: $(TXT_FILES)"

# Generate all .txt files and auto-disassembly before cleanup
all-auto-disasm: $(TXT_FILES) $(DISASM_FILES)
	@echo "=== All assembly files converted with auto-disassembly ==="
	@echo "Generated files: $(TXT_FILES)"
	@echo "Disassembly files: $(DISASM_FILES)"

# Build specific file group (usage: make target-group)
target-group:
ifdef TARGET_FILES
	@echo "Building specific target files: $(TARGET_FILES)"
	@$(MAKE) ASM_FILES="$(TARGET_FILES)" all
else
	@echo "No TARGET_FILES defined. Please uncomment and modify TARGET_FILES in Makefile."
	@echo "Example: TARGET_FILES = inst_la_alu.s inst_la_mem.s"
endif

# Rule to convert .s -> .o -> .elf -> .bin -> .txt
# 手动转换成小端序：
%.txt: %.bin
	@echo "Converting $< to $@..."
	hexdump -v -e '1/4 "%08x\n"' $< > $@
#	xxd -p -c 4 $< | tr -d '\n' | sed 's/\(........\)/\1\n/g' > $@

# Enhanced rule: .txt with auto-disassembly before cleanup
%.txt.auto: %.elf
	@echo "Auto-generating disassembly and output for $<..."
	@# First generate disassembly from ELF
	@$(MAKE) $(<:.elf=_disasm.s)
	@# Then generate binary and txt
	@$(OBJCOPY) -O binary $< $(<:.elf=.bin)
	@hexdump -v -e '1/4 "%08x\n"' $(<:.elf=.bin) > $(<:.elf=.txt)
	@# Clean up intermediate files but keep disassembly
	@rm -f $(<:.elf=.o) $< $(<:.elf=.bin)
	@echo "Generated: $(<:.elf=.txt) and $(<:.elf=_disasm.s)"
	@# Create marker file
	@touch $@

# Rule to disassemble from ELF files to real assembly code
%_disasm.s: %.elf
	@echo "Disassembling $< to $@..."
	@echo "# Disassembled from $<" > $@
	@echo "# Generated by loongarch32r-linux-gnusf-objdump" >> $@
	@echo "" >> $@
	@loongarch32r-linux-gnusf-objdump -d $< >> $@
	@echo "" >> $@
	@echo "# End of disassembly" >> $@


%.bin: %.elf
	@echo "Extracting binary from $<..."
	$(OBJCOPY) -O binary $< $@

%.elf: %.o
	@echo "Linking $< to $@..."
# Link the object file to create ELF, so that <_start> is located at 0x1c00_0000
	$(LD) -T linker.ld $< -o $@ 

%.o: %.s
	@echo "Assembling $< to $@..."
	$(AS) $(ASFLAGS) $< -o $@

# Clean generated files
clean:
	@echo "Cleaning generated files..."
	rm -f $(OBJ_FILES) $(ELF_FILES) $(BIN_FILES) $(TXT_FILES) $(DISASM_FILES)
	rm -f *.txt.auto  # Clean auto-disassembly marker files
	@echo "Clean completed."

# Show available .s files
list:
	@echo "Available .s assembly files:"
	@echo "$(ASM_FILES)"
	@echo ""
	@echo "Will generate .txt files:"
	@echo "$(TXT_FILES)"

# Convert specific file (usage: make FILE=example.s)
build-file:
ifdef FILE
	@if [ -f "$(FILE)" ]; then \
		echo "Building $(FILE) to $(FILE:.s=.txt)..."; \
		$(MAKE) $(FILE:.s=.txt); \
	else \
		echo "Error: File $(FILE) not found!"; \
		exit 1; \
	fi
else
	@echo "Usage: make build-file FILE=filename.s"
endif

# Build specific file with auto-disassembly before cleanup
build-file-auto:
ifdef FILE
	@if [ -f "$(FILE)" ]; then \
		echo "Building $(FILE) with auto-disassembly before cleanup..."; \
		$(MAKE) $(FILE:.s=.txt.auto); \
	else \
		echo "Error: File $(FILE) not found!"; \
		exit 1; \
	fi
else
	@echo "Usage: make build-file-auto FILE=filename.s"
endif

# Help information
help:
	@echo "================================================================"
	@echo "=== LoongArch Assembly to Binary Machine Code Converter ==="
	@echo "================================================================"
	@echo "Available targets:"
	@echo "Basic build:"
	@echo "  make                      : Convert all .s files to .txt (default)"
	@echo "  make all                  : Same as above"
	@echo "  make all-auto-disasm      : Build all + auto-disassembly before cleanup"
	@echo ""
	@echo "Single file build:"
	@echo "  make build-file FILE=xxx.s     : Build specific file (default)"
	@echo "  make build-file-auto FILE=xxx.s: Build + auto-disassembly before cleanup"
	@echo ""
	@echo "Other targets:"
	@echo "  make target-group         : Build specific TARGET_FILES (modify in Makefile)"
	@echo "  make list                 : Show available .s files"
	@echo "  make clean                : Remove all generated files"
	@echo "  make help                 : Show this help"
	@echo ""
	@echo "File workflow:"
	@echo "  Standard:    .s -> .o -> .elf -> .bin -> .txt (cleanup intermediates)"
	@echo "  Auto-disasm: .s -> .o -> .elf -> _disasm.s + .txt (cleanup .o,.elf,.bin)"
	@echo ""
	@echo "Output formats:"
	@echo "  .txt files: hex machine code (32 bits per line)"
	@echo "  _disasm.s:  real LA32r assembly code with addresses"
	@echo ""
	@echo "Manual target selection:"
	@echo "  1. Uncomment TARGET_FILES line in Makefile"
	@echo "  2. List your desired .s files"
	@echo "  3. Run 'make target-group'"
	@echo "================================================================"

# Show detailed process for debugging
debug: SHELL:=/bin/bash
debug:
	@echo "=== Debug Information ==="
	@echo "ASM_FILES: $(ASM_FILES)"
	@echo "TXT_FILES: $(TXT_FILES)"
	@echo "OBJ_FILES: $(OBJ_FILES)"
	@echo "ELF_FILES: $(ELF_FILES)"
	@echo "BIN_FILES: $(BIN_FILES)"
	@echo "Toolchain:"
	@echo "  AS: $(AS)"
	@echo "  LD: $(LD)"
	@echo "  OBJCOPY: $(OBJCOPY)"

.PHONY: default all all-auto-disasm target-group clean list build-file build-file-auto help debug
