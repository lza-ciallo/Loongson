# LoongArch汇编编译器工具

## 概述

这是一个专门为LoongArch架构设计的汇编文件编译工具，能够将`.s`汇编源文件转换为十六进制机器码`.txt`文件，并可选择性地生成反汇编文件。

## 功能特点

- ✅ 自动发现并编译所有`.s`汇编文件
- ✅ 生成十六进制机器码（32位/行）
- ✅ 自动反汇编功能
- ✅ 智能中间文件管理
- ✅ 支持单文件和批量处理
- ✅ 支持自定义文件组编译

## 系统要求

- **操作系统**: WSL (Windows Subsystem for Linux) 或 Linux
- **工具链**: LoongArch32r交叉编译工具链
  - `loongarch32r-linux-gnusf-as`
  - `loongarch32r-linux-gnusf-ld` 
  - `loongarch32r-linux-gnusf-objcopy`
  - `loongarch32r-linux-gnusf-objdump`
- **其他工具**: `hexdump`, `make`, `awk`

## 快速开始

### 基本用法

```bash
# 编译所有.s文件为.txt机器码
make

# 查看帮助信息
make help

# 列出可用的汇编文件
make list

# 清理所有生成文件
make clean
```

### 单文件编译

```bash
# 标准编译（自动清理中间文件）
make build-file FILE=inst_la_alu.s

# 带自动反汇编的编译
make build-file-auto FILE=inst_la_alu.s
```

## 详细功能说明

### 基础构建命令

| 命令 | 功能 | 输出文件 |
|------|------|----------|
| `make` | 编译所有.s文件（默认） | `*.txt` |
| `make all` | 同上 | `*.txt` |
| `make all-auto-disasm` | 编译所有文件并自动反汇编 | `*.txt` + `*_disasm.s` |

### 单文件构建命令

| 命令 | 功能 | 输出文件 |
|------|------|----------|
| `make build-file FILE=xxx.s` | 编译指定文件 | `xxx.txt` |
| `make build-file-auto FILE=xxx.s` | 编译指定文件并自动反汇编 | `xxx.txt` + `xxx_disasm.s` |

### 其他命令

| 命令 | 功能 |
|------|------|
| `make target-group` | 编译自定义文件组 |
| `make list` | 显示所有可用的.s文件 |
| `make clean` | 清理所有生成文件 |
| `make debug` | 显示调试信息 |
| `make help` | 显示帮助信息 |

## 编译流程

### 标准流程
```
.s汇编源文件 → .o目标文件 → .elf可执行文件 → .bin二进制文件 → .txt机器码
                ↓
        (自动删除中间文件)
```

### 自动反汇编流程
```
.s汇编源文件 → .o目标文件 → .elf可执行文件 → .bin二进制文件 → .txt机器码
                              ↓
                        _disasm.s反汇编文件
                              ↓
                    (删除.o, .elf, .bin中间文件)
```

## 输出文件格式

### .txt文件（十六进制机器码）
```
00101001
001c0c41
001c0421
29800001
```
- 每行包含一条32位指令的十六进制表示
- 使用小端序格式

### _disasm.s文件（反汇编代码）
```assembly
# Disassembled from inst_la_alu.elf
# Generated by loongarch32r-linux-gnusf-objdump

inst_la_alu.elf:     file format elf32-loongarch

Disassembly of section .text:

00000000 <.text>:
   0:	00101001 	add.w	$r1,$r0,$r4
   4:	001c0c41 	mul.w	$r1,$r2,$r3
   8:	001c0421 	mul.w	$r1,$r1,$r1

# End of disassembly
```

## 高级用法

### 自定义文件组编译

1. 编辑Makefile，取消注释并修改`TARGET_FILES`行：
```makefile
TARGET_FILES = inst_la_alu.s inst_la_mem.s inst_la_branch.s
ASM_FILES = $(TARGET_FILES)
```

2. 运行目标组编译：
```bash
make target-group
```

### 工具链配置

如果工具链不在标准路径，可以修改Makefile中的工具链定义：
```makefile
AS = /path/to/loongarch32r-linux-gnusf-as
LD = /path/to/loongarch32r-linux-gnusf-ld
OBJCOPY = /path/to/loongarch32r-linux-gnusf-objcopy
```

## 使用示例

### 示例1：编译单个文件
```bash
$ make build-file FILE=inst_la_mem.s
Building inst_la_mem.s to inst_la_mem.txt...
Assembling inst_la_mem.s to inst_la_mem.o...
Linking inst_la_mem.o to inst_la_mem.elf...
Extracting binary from inst_la_mem.elf...
Converting inst_la_mem.bin to inst_la_mem.txt...

$ ls inst_la_mem.*
inst_la_mem.s  inst_la_mem.txt
```

### 示例2：带反汇编的编译
```bash
$ make build-file-auto FILE=inst_la_mem.s
Building inst_la_mem.s with auto-disassembly before cleanup...
Auto-generating disassembly and output for inst_la_mem.elf...
Disassembling inst_la_mem.elf to inst_la_mem_disasm.s...
Generated: inst_la_mem.txt and inst_la_mem_disasm.s

$ ls inst_la_mem.*
inst_la_mem.s  inst_la_mem.txt  inst_la_mem_disasm.s
```

### 示例3：批量编译
```bash
$ make all-auto-disasm
=== All assembly files converted with auto-disassembly ===
Generated files: inst_la_alu.txt inst_la_mem.txt
Disassembly files: inst_la_alu_disasm.s inst_la_mem_disasm.s
```

## 常见问题解决

### Q: 提示找不到工具链命令
**A:** 确保LoongArch工具链已正确安装并添加到PATH环境变量中：
```bash
export PATH="/opt/loongarch32r-linux-gnusf-2022-05-20/bin:$PATH"
```

### Q: 汇编过程中出现警告
**A:** 检查汇编源文件格式，确保文件末尾有正确的换行符。

### Q: make命令不工作
**A:** 确保在WSL环境中运行，而不是Windows命令行。

### Q: 反汇编文件为空
**A:** 检查ELF文件是否正确生成，或使用简化的反汇编命令进行调试。

## 文件结构

```
compile_env/
├── Makefile              # 主编译脚本
├── README.md            # 本说明文档
├── inst_la_alu.s        # 汇编源文件示例
├── inst_la_mem.s        # 汇编源文件示例
├── inst_la_alu.txt      # 生成的机器码文件
├── inst_la_mem.txt      # 生成的机器码文件
├── inst_la_alu_disasm.s # 反汇编文件
└── inst_la_mem_disasm.s # 反汇编文件
```

## 技术细节

- **架构**: LoongArch32r
- **ABI**: ilp32 (32位整数、long、指针)
- **字节序**: Little-Endian（小端序）
- **指令长度**: 32位固定长度
- **编译器**: GCC交叉编译工具链

## 版本信息

- **版本**: 1.0
- **作者**: 为LoongArch汇编到二进制机器码转换而创建
- **最后更新**: 2025年7月21日

## 许可证

本工具遵循开源许可证，可自由使用和修改。

---

如需更多帮助，请运行 `make help` 查看内置帮助信息。
